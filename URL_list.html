<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="Bookmark" href="/favicon.ico">
    <link rel="Shortcut Icon" href="/favicon.ico" />
<script>
        document.domain = '192.168.1.4'
    </script>
    <link rel="stylesheet" type="text/css" href="static/h-ui/css/H-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/H-ui.admin.css" />
    <link rel="stylesheet" type="text/css" href="lib/Hui-iconfont/1.0.8/iconfont.css" />
    <link rel="stylesheet" type="text/css" href="static/h-ui.admin/skin/default/skin.css" id="skin" />
    <link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/style.css" />
    <!--[if IE 6]>
<script type="text/javascript" src="lib/DD_belatedPNG_0.0.8a-min.js" ></script>
<script>DD_belatedPNG.fix('*');</script>
<![endif]-->
    <title></title>
</head>

<body>
    <div class="page-container">

        <!--div class="cl pd-5 bg-1 bk-gray mt-20">
            <label class="form-label col-xs-4 ><span class=" c-red">*</span>URL:</label>
            <div class="formControls col-xs-8 col-sm-9">
                <input type="text" class="input-text" value="" placeholder="" id="adminName" name="adminName">
            </div-->
            <!--label class="form-label col-xs-4" style="float: none">Marketplace：</label></br>
            <div class="formControls col-xs-8 col-sm-9" style="width:20%;"> <span class="select-box">
                    <select class="select" name="adminRole" size="1" id='Marketplace'>
                        <option value="Amazon">Amazon</option>
                        <option value="Ebay">Ebay</option>

                    </select>
                </span>

            </div-->
            <!--div style="margin-left: -50px;"> <span class="l"> <a href="javascript:;" id='prodcte_add' onclick="prodcte_add()" class="btn btn-primary radius"><i class="Hui-iconfont">&#xe600;</i> Add URL</a></span></div>

        </div-->

        <div class="cl pd-5 bg-1 bk-gray mt-20"> <span class="l"><a href="javascript:;" id='submit' class="btn btn-danger radius"> Download</a> 
		<!--a target="_blank" href="info.html" id="openNewTab" class="btn btn-success radius"> Price Tracking</a></div-->
		<a  id="openNewTab" class="btn btn-success radius"> Price Tracking</a></div>

        <table class="table table-border table-bordered table-bg" id="table">

        </table>
    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>

    <script type="text/javascript" src="multiselect/jquery-ui-1.11.2.min.js"></script>
    <script type="text/javascript" src="lib/layer/2.4/layer.js"></script>
    <script type="text/javascript" src="lib/My97DatePicker/4.8/WdatePicker.js"></script>

    <script type="text/javascript" src="multiselect/ui.dropdownchecklist.js"></script>
    <script type="text/javascript" src="lib/accounting.min.js"></script>
    <script type="text/javascript" src="static/h-ui/js/H-ui.min.js"></script>
    <script type="text/javascript" src="static/h-ui.admin/js/H-ui.admin.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script type="text/javascript" src="lib/accounting.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/3.2.6/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.2.7/js/dataTables.select.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.flash.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.19/features/searchHighlight/dataTables.searchHighlight.min.js"></script>
    <script type="text/javascript" src="https://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
    <script type="text/javascript" src="dataTables/sum.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.es6.js"></script>

    <script type="text/javascript">
        var seletedArr = [];
        $(document).ready(function() {
            console.log("ready!");
            getURL();
			 $('#openNewTab').on('click', function() {
               openNewPage();
            });
        });

        function getURL() {
            $.ajax({
                url: 'getURL.php',
                type: 'post',
                success: function(output) {
                    var obj = jQuery.parseJSON(output);
                    displayTable(obj)
                }
            });


        }
        var table
		function openNewPage()
		{
			var url="http://192.168.1.4/pricetracking/info.html";
			creatIframe(url,"Price Tracking")
		
		}
        function displayTable(data) {

            table = $('#table').DataTable({
                "autoWidth": true,
                scrollCollapse: true,
                paging: false,
                select: true,
                fixedColumns: true,
                data: data,

                columns: [{
                        data: 'Item_ID',
                        title: "<input name='select_all' value='1' id='example-select-all' type='checkbox' />"
                    }, {
                        "title": "Customer",
                        "data": "Customer"
                    },
                    {
                        "title": "URL",
                        "data": "URL2",
                        render: function(data, type, row) {

							return '<a href="' + data + '" name="newtab" target="_blank" >'+data+'</a>';
                           /* return data.length > 10 ?
                                data.substr(0, 300) :
                                data;*/
                        }
                    },
                    {
                        "title": "URL",
                        "data": "URL2",
                        render: function(data, type, row) {
                            //console.log(data)
                            return '<a href="' + data + '" target="_blank" >click here to check</a>';

                        }
                    },

                    {
                        "title": "Status",
                        "data": "URL2",
                        "render": function(data, type, row, meta) {

                            return '<a id="' + data + '" name='+meta.row+'  href="javascript:;" title="Delete" style="text-decoration:none"><i class="Hui-iconfont">&#xe631;</i></a>';
                        }

                    },

                ],
                'columnDefs': [{
                    'targets': 0,
                    'searchable': false,
                    'orderable': false,
                    'className': 'dt-body-center',
                    'render': function(data, type, full, meta) {
                        //console.log(full)
                        return '<input type="checkbox" name=' + full.Customer + ' id="' + full.URL2 + '" status="' + full.Status + '" URL="' + full.URL +'" value="' + full.tag1 +'" title="' + full.rank + '">';
                    }
                }],
                'order': [1, 'asc'],

            });

            $('#example-select-all').on('click', function() {
                // Check/uncheck all checkboxes in the table
                //var rows = table.rows({
                //    'search': 'applied',
                //}).nodes();
                var rows = table.rows({
                    page: 'current'
                }).nodes();
                var info = table.page.info();
                $('input[type="checkbox"]', rows).prop('checked', this.checked);
            });
            // Handle click on checkbox to set state of "Select all" control
            $('#table tbody').on('change', 'input[type="checkbox"]', function() {
                // If checkbox is not checked
                if (!this.checked) {
                    var el = $('#example-select-all').get(0);
                    // If "Select all" control is checked and has 'indeterminate' property
                    if (el && el.checked && ('indeterminate' in el)) {
                        // Set visual state of "Select all" control 
                        // as 'indeterminate'
                        el.indeterminate = true;
                    }
                }
            });
            $("#submit").click(function() {
                var form = this;
                seletedArr = [];
                // Iterate over all checkboxes in the table
                table.$('input[type="checkbox"]').each(function() {
                    // If checkbox doesn't exist in DOM

                    // If checkbox is checked
                    if (this.checked) {
                        // Create a hidden element 
                        var obj = {};
                        obj.url = this.id;
                        obj.name = this.name;
                        obj.tag = this.value;
                        obj.rank = this.title;
                        seletedArr.push(obj);


                    }


                });
                if (seletedArr.length > 0) {
                    downloadData(seletedArr[0]);
                    seletedArr.splice(0, 1);
                } else {
                    alert("please select an item!")
                }

            })

			$('#table').on("click", "a", function(){
			  console.log($(this).parent());
			 if(this.name!='newtab')
			 {
			  delectItem(this,this.id)
			 }
			 
			});


        }
		 function delectItem(obj,data2)
		 {
			
			 $.ajax({
                        url: 'delete_item.php',
                        type: 'post',
                        data: {
                            URL: data2,

                        },
                        success: function(output) {
                            if (output == "1" || output == "2") {
								 table.row($(obj).parents('tr')).remove().draw(false);
                            } else {
                                alert("Error");
                            }
                        }
            });
		 }
        var tid;
        var timerStatus = false;

        function downloadData(item) {
		 loadingLayer();
            if (item.name == 'Amazon') {


                if (item.url != '') {
                    $.ajax({
                        url: 'amazon_extract_price.php',
                        type: 'post',
                        data: {
                            URL: item.url,
                            TAG: item.tag,
							RANK: item.rank,

                        },
                        success: function(output) {
                            if (output == "1" || output == "2") {

                            } else {
                                //alert(item.url);
								console.log(output)
								console.log(item.url+"<br>")
								
                            }
                        }
                    });

                }
            } else {
                if (item.url != '') {
                    $.ajax({
                        url: 'ebay_extract_price.php',
                        type: 'post',
                        data: {
                            URL: item.url,
							 TAG: item.tag,
							RANK: item.rank,
                        },
                        success: function(output) {
                            if (output == "1" || output == "2") {

                            } else {
                                //alert("Error");
								console.log(output)
								console.log(item.url+"<br>")
                            }
                        }
                    });

                }


            }
            if (timerStatus == false) {
                tid = setInterval(mycode, 1000);
                timerStatus = true;

            }
		
        }

        function prodcte_add() {
			var marketplace="";
			var url2="";
            var targetUrl = $('#adminName').val();
            if (targetUrl == "") {
                alert('Enter a amazon or ebay URL');
                return;
            }
			var n1 = targetUrl.includes("www.amazon.com");
			var n2 = targetUrl.includes("www.ebay.com");
			if(n1==true)
			{
				 marketplace = "Amazon";
			}
			if(n2==true)
			{
				marketplace="Ebay";
			}
			if(n1==false && n2==false)
			{
				alert('Enter a amazon or ebay URL!');
				return;
			}
           
			if(marketplace=="Amazon")
			{
				var regex = RegExp("https://www.amazon.com/([\\w-]+/)?(dp|gp/product)/(\\w+/)?(\\w{10})");
				m = targetUrl.match(regex);
				if (m) { 
					url2="https://www.amazon.com/"+m[2]+"/"+m[4];
				}
				
			}
			else if(marketplace=="Ebay")
			{
			var regex = RegExp("(?:[/itm/]|$)([A-Z0-9]{12})");
			m = targetUrl.match(regex);
				if (m) { 
					url2="https://www.ebay.com/itm"+m[0];
				}
			}

            $.ajax({
                url: 'addURL.php',
                type: 'post',
                data: {
                    URL: targetUrl,
                    Marketplace: marketplace,
                    URL2: url2
                },
                success: function(output) {
                    if (output == "1") {
                        table.row.add({
                            "Customer": marketplace,
                            "URL": targetUrl,
                            "Status": "1",
                            "URL2": url2,

                        }).draw();
                        alert("New record created successfully");
                        $('#adminName').val('')
                    } else if (output == "2") {
                       
                        alert("This item already exists!");
						$('#adminName').val('')
                        
                    } else {
                        alert("Error");
                    }
                }
            });
        }


        function mycode() {
            if (seletedArr.length > 0) {
                downloadData(seletedArr[0])
                seletedArr.splice(0, 1);
            } else {
                if (timerStatus == true) {
                    abortTimer()
					layer.close(layerIndex);
                    alert("done");
                    timerStatus = false;
					

                }


            }

        }

        function abortTimer() { // to be called when you want to stop the timer
            clearInterval(tid);
        }
		var layerIndex;
		  function loadingLayer() {
            layerIndex = layer.load(1, {
                shade: [0.3, '#fff']
            });

        }
    </script>
</body>

</html>